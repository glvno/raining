import{x as I,a as s,q as e,y as k,z as P,A as $,w as F}from"./chunk-JMJ3UQ3L-D46zko18.js";import{u as w,A as M}from"./AuthContext-DYnFcO9l.js";const D=()=>{const t=I(),{login:o,register:g,error:n,clearError:c,isAuthenticated:r}=w(),[a,d]=s.useState("login"),[m,p]=s.useState(""),[h,i]=s.useState(""),[l,b]=s.useState(!1),[x,j]=s.useState(null);s.useEffect(()=>{r&&t("/",{replace:!0})},[r,t]);const N=async y=>{y.preventDefault(),b(!0),j(null),c();try{a==="login"?await o(m,h):await g(m,h)}catch{}finally{b(!1)}},E=y=>{d(y),j(null),c()};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-gray-100 flex items-center justify-center px-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-8 w-full max-w-md",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold text-gray-900 mb-2",children:"ðŸŒ§ï¸ Raining"}),e.jsx("p",{className:"text-gray-600",children:a==="login"?"Welcome back!":"Create your account"})]}),e.jsxs("div",{className:"flex gap-2 mb-6",children:[e.jsx("button",{type:"button",onClick:()=>E("login"),className:`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${a==="login"?"bg-blue-500 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"Login"}),e.jsx("button",{type:"button",onClick:()=>E("register"),className:`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${a==="register"?"bg-blue-500 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"Register"})]}),e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{id:"email",type:"email",value:m,onChange:y=>p(y.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"you@example.com",disabled:l})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{id:"password",type:"password",value:h,onChange:y=>i(y.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",disabled:l})]}),e.jsx("button",{type:"submit",disabled:l,className:`w-full py-3 rounded-lg font-medium transition-colors ${l?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-blue-500 text-white hover:bg-blue-600"}`,children:l?"Please wait...":a==="login"?"Login":"Create Account"})]}),x&&e.jsx("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-green-800",children:x})}),n&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-800",children:n})})]})})},C="raining_location",_="/api",T=3e4,R=s.createContext(void 0);function z({children:t}){const{token:o,isAuthenticated:g}=w(),[n,c]=s.useState(null),[r,a]=s.useState(null),[d,m]=s.useState(!1),[p,h]=s.useState(0),[i,l]=s.useState(!0),[b,x]=s.useState(null);s.useEffect(()=>{const u=localStorage.getItem(C);if(u)try{const{lat:f,lng:v}=JSON.parse(u);c(f),a(v)}catch(f){console.error("Failed to parse cached location:",f)}},[]),s.useEffect(()=>{!n||!r?j():l(!1)},[]),s.useEffect(()=>{n&&r&&g&&o&&N()},[n,r,g,o]),s.useEffect(()=>{if(!n||!r||!g||!o)return;const u=setInterval(()=>{N()},T);return()=>clearInterval(u)},[n,r,g,o]);const j=()=>{if(l(!0),x(null),!navigator.geolocation){x("Geolocation is not supported by your browser"),l(!1);return}navigator.geolocation.getCurrentPosition(u=>{const f=u.coords.latitude,v=u.coords.longitude;c(f),a(v),localStorage.setItem(C,JSON.stringify({lat:f,lng:v})),l(!1)},u=>{x(`Unable to get location: ${u.message}`),l(!1)},{enableHighAccuracy:!1,timeout:1e4,maximumAge:3e5})},N=async()=>{if(!(!n||!r||!o))try{const u=await fetch(`${_}/droplets/feed?latitude=${n}&longitude=${r}`,{headers:{Authorization:`Bearer ${o}`}});if(!u.ok)throw new Error("Failed to check rain status");const f=await u.json(),v=f.droplets.length>0||f.count>0;m(v),h(f.count||0),x(null)}catch(u){const f=u instanceof Error?u.message:"Failed to check rain status";x(f)}},L={latitude:n,longitude:r,isRaining:d,rainAreaSize:p,isLoading:i,error:b,refreshRainStatus:async()=>{await N()},setManualLocation:(u,f)=>{console.warn("Manual location override is only available in development mode")}};return e.jsx(R.Provider,{value:L,children:t})}function A(){const t=s.useContext(R);if(t===void 0)throw new Error("useLocation must be used within a LocationProvider");return t}const B="/api",S=500;function H({onDropletCreated:t}){const[o,g]=s.useState(""),[n,c]=s.useState(!1),[r,a]=s.useState(null),{token:d}=w(),{latitude:m,longitude:p}=A(),h=o.length,i=h===0||h>S||n,l=async b=>{if(b.preventDefault(),!m||!p){a("Location not available");return}if(!i){c(!0),a(null);try{const x=await fetch(`${B}/droplets`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({droplet:{content:o,latitude:m,longitude:p}})});if(!x.ok){const N=await x.json();throw new Error(N.error||"Failed to post droplet")}const j=await x.json();t(j.droplet),g(""),a(null)}catch(x){const j=x instanceof Error?x.message:"Failed to post droplet";a(j)}finally{c(!1)}}};return e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6",children:e.jsxs("form",{onSubmit:l,children:[e.jsx("textarea",{value:o,onChange:b=>g(b.target.value),placeholder:"What's happening in the rain?",className:"w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:3,disabled:n}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:`text-sm font-medium ${h>S?"text-red-600":h>S*.9?"text-orange-600":"text-gray-500"}`,children:[h," / ",S]})}),e.jsx("button",{type:"submit",disabled:i,className:`px-6 py-2 rounded-full font-medium transition-colors ${i?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-blue-500 text-white hover:bg-blue-600"}`,children:n?"Posting...":"Post"})]}),r&&e.jsx("div",{className:"mt-3 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-800",children:r})})]})})}function O(t){const o=new Date(t),n=new Date().getTime()-o.getTime(),c=Math.floor(n/1e3),r=Math.floor(c/60),a=Math.floor(r/60),d=Math.floor(a/24);return c<60?"just now":r<60?`${r} minute${r!==1?"s":""} ago`:a<24?`${a} hour${a!==1?"s":""} ago`:d<7?`${d} day${d!==1?"s":""} ago`:o.toLocaleDateString()}function q({droplet:t}){return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow",children:[e.jsx("div",{className:"flex items-start justify-between mb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-semibold",children:t.user.email.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.user.email}),e.jsx("p",{className:"text-sm text-gray-500",children:O(t.inserted_at)})]})]})}),e.jsx("p",{className:"text-gray-800 whitespace-pre-wrap break-words",children:t.content}),e.jsxs("div",{className:"mt-3 flex items-center gap-2 text-xs text-gray-400",children:[e.jsx("span",{children:"ðŸ“"}),e.jsxs("span",{children:[t.latitude.toFixed(2),", ",t.longitude.toFixed(2)]})]})]})}function J({dropletCount:t}){return e.jsxs("div",{className:"bg-blue-100 text-blue-800 px-4 py-2 rounded-full inline-flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"ðŸŒ§ï¸"}),e.jsxs("span",{className:"font-medium",children:[t," droplet",t!==1?"s":""," in your rain area"]})]})}const G="/api",U=3e4;function V(){const[t,o]=s.useState([]),[g,n]=s.useState(!0),[c,r]=s.useState(null),{token:a}=w(),{latitude:d,longitude:m}=A();s.useEffect(()=>{d&&m&&a&&p()},[d,m,a]),s.useEffect(()=>{if(!d||!m||!a)return;const i=setInterval(()=>{p()},U);return()=>clearInterval(i)},[d,m,a]);const p=async()=>{if(!(!d||!m||!a))try{const i=await fetch(`${G}/droplets/feed?latitude=${d}&longitude=${m}`,{headers:{Authorization:`Bearer ${a}`}});if(!i.ok)throw new Error("Failed to load feed");const l=await i.json();o(l.droplets),r(null)}catch(i){const l=i instanceof Error?i.message:"Failed to load feed";r(l)}finally{n(!1)}},h=i=>{o(l=>[i,...l])};return g?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"text-4xl animate-pulse",children:"ðŸŒ§ï¸"}),e.jsx("p",{className:"text-gray-600",children:"Loading feed..."})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ðŸŒ§ï¸ Raining"}),e.jsx(J,{dropletCount:t.length})]}),e.jsx(H,{onDropletCreated:h}),c&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-800",children:c})}),e.jsx("div",{className:"space-y-4",children:t.length===0?e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center",children:[e.jsx("div",{className:"text-4xl mb-4",children:"ðŸ’§"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No droplets yet"}),e.jsx("p",{className:"text-gray-600",children:"Be the first to post in your rain area!"})]}):t.map(i=>e.jsx(q,{droplet:i},i.id))})]})})}function W(){return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-gray-100",children:e.jsxs("div",{className:"text-center space-y-6 px-4",children:[e.jsx("h1",{className:"text-6xl font-bold text-gray-800",children:"You have better things to do!"}),e.jsx("p",{className:"text-2xl text-gray-600",children:"Come back when it's raining"}),e.jsx("div",{className:"text-6xl mt-8",children:"â˜€ï¸"})]})})}function Y({children:t}){const{isAuthenticated:o,isLoading:g}=w(),{isRaining:n,isLoading:c,error:r}=A();return g||c?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"text-4xl animate-pulse",children:"ðŸŒ§ï¸"}),e.jsx("p",{className:"text-gray-600",children:"Loading..."})]})}):o?r?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center space-y-4 px-4",children:[e.jsx("div",{className:"text-4xl",children:"âš ï¸"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Location Error"}),e.jsx("p",{className:"text-gray-600",children:r}),e.jsx("p",{className:"text-sm text-gray-500",children:"Please enable location permissions and refresh the page"})]})}):n?e.jsx(e.Fragment,{children:t}):e.jsx(W,{}):e.jsx(k,{to:"/login",replace:!0})}const K=()=>e.jsx(M,{children:e.jsx(z,{children:e.jsxs(P,{children:[e.jsx($,{path:"/login",element:e.jsx(D,{})}),e.jsx($,{path:"/",element:e.jsx(Y,{children:e.jsx(V,{})})})]})})}),Z=F(function(){return e.jsx(K,{})});export{Z as default};
