import{a as s,q as e,v as M,x as O,y as I,z as _,A as R,w as B}from"./chunk-JMJ3UQ3L-DyXDjqW6.js";const E="raining_auth_token",A="/api",F=s.createContext(void 0);function z({children:t}){const[a,l]=s.useState(null),[o,c]=s.useState(null),[r,n]=s.useState(!0),[x,d]=s.useState(null),j=!!a&&!!o;s.useEffect(()=>{const h=localStorage.getItem(E);h?(l(h),f(h)):n(!1)},[]);const f=async h=>{const v=h||a;if(!v){n(!1);return}try{const i=await fetch(`${A}/me`,{headers:{Authorization:`Bearer ${v}`}});if(i.ok){const b=await i.json();c(b),l(v),localStorage.setItem(E,v)}else l(null),c(null),localStorage.removeItem(E)}catch{d("Failed to verify authentication"),l(null),c(null),localStorage.removeItem(E)}finally{n(!1)}},N={token:a,user:o,isAuthenticated:j,isLoading:r,error:x,login:async(h,v)=>{n(!0),d(null);try{const i=await fetch(`${A}/users/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:h,password:v})});if(!i.ok){const g=await i.json();throw new Error(g.error||"Login failed")}const b=await i.json();l(b.token),c(b.user),localStorage.setItem(E,b.token)}catch(i){const b=i instanceof Error?i.message:"Login failed";throw d(b),i}finally{n(!1)}},register:async(h,v)=>{n(!0),d(null);try{const i=await fetch(`${A}/users/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user:{email:h,password:v}})});if(!i.ok){const g=await i.json();throw new Error(g.error||"Registration failed")}const b=await i.json();l(b.token),c(b.user),localStorage.setItem(E,b.token)}catch(i){const b=i instanceof Error?i.message:"Registration failed";throw d(b),i}finally{n(!1)}},logout:async()=>{n(!0);try{a&&await fetch(`${A}/users/logout`,{method:"DELETE",headers:{Authorization:`Bearer ${a}`}})}catch(h){console.error("Logout API call failed:",h)}finally{l(null),c(null),localStorage.removeItem(E),n(!1)}},checkAuth:()=>f(),clearError:()=>d(null)};return e.jsx(F.Provider,{value:N,children:t})}function L(){const t=s.useContext(F);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t}const H=()=>{const t=M(),{login:a,register:l,error:o,clearError:c,isAuthenticated:r}=L(),[n,x]=s.useState("login"),[d,j]=s.useState(""),[f,u]=s.useState(""),[m,S]=s.useState(!1),[p,N]=s.useState(null);s.useEffect(()=>{r&&t("/",{replace:!0})},[r,t]);const h=async i=>{i.preventDefault(),S(!0),N(null),c();try{n==="login"?await a(d,f):await l(d,f)}catch{}finally{S(!1)}},v=i=>{x(i),N(null),c()};return e.jsx("div",{className:"min-h-full bg-gradient-to-br from-blue-50 to-gray-100 flex items-center justify-center px-4 py-12",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-8 w-full max-w-md",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold text-gray-900 mb-2",children:"ðŸŒ§ï¸ Raining"}),e.jsx("p",{className:"text-gray-600",children:n==="login"?"Welcome back!":"Create your account"})]}),e.jsxs("div",{className:"flex gap-2 mb-6",children:[e.jsx("button",{type:"button",onClick:()=>v("login"),className:`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${n==="login"?"bg-blue-500 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"Login"}),e.jsx("button",{type:"button",onClick:()=>v("register"),className:`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${n==="register"?"bg-blue-500 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"Register"})]}),e.jsxs("form",{onSubmit:h,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{id:"email",type:"email",value:d,onChange:i=>j(i.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"you@example.com",disabled:m})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{id:"password",type:"password",value:f,onChange:i=>u(i.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",disabled:m})]}),e.jsx("button",{type:"submit",disabled:m,className:`w-full py-3 rounded-lg font-medium transition-colors ${m?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-blue-500 text-white hover:bg-blue-600"}`,children:m?"Please wait...":n==="login"?"Login":"Create Account"})]}),p&&e.jsx("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-green-800",children:p})}),o&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-800",children:o})})]})})},P="raining_location",J="/api",q=3e4,T=s.createContext(void 0);function K({children:t}){const{token:a,isAuthenticated:l}=L(),[o,c]=s.useState(null),[r,n]=s.useState(null),[x,d]=s.useState(!1),[j,f]=s.useState(0),[u,m]=s.useState(!0),[S,p]=s.useState(null);s.useEffect(()=>{const g=localStorage.getItem(P);if(g)try{const{lat:y,lng:w}=JSON.parse(g);c(y),n(w)}catch(y){console.error("Failed to parse cached location:",y)}},[]),s.useEffect(()=>{!o||!r?N():m(!1)},[]),s.useEffect(()=>{o&&r&&l&&a&&h()},[o,r,l,a]),s.useEffect(()=>{if(!o||!r||!l||!a)return;const g=setInterval(()=>{h()},q);return()=>clearInterval(g)},[o,r,l,a]);const N=()=>{if(m(!0),p(null),!navigator.geolocation){p("Geolocation is not supported by your browser"),m(!1);return}navigator.geolocation.getCurrentPosition(g=>{const y=g.coords.latitude,w=g.coords.longitude;c(y),n(w),localStorage.setItem(P,JSON.stringify({lat:y,lng:w})),m(!1)},g=>{p(`Unable to get location: ${g.message}`),m(!1)},{enableHighAccuracy:!1,timeout:1e4,maximumAge:3e5})},h=async()=>{if(!(!o||!r||!a))try{const g=`${J}/droplets/feed?latitude=${o}&longitude=${r}`;console.log("[LocationContext] Checking rain status at:",{latitude:o,longitude:r,url:g});const y=await fetch(g,{headers:{Authorization:`Bearer ${a}`}});if(console.log("[LocationContext] Response status:",y.status),!y.ok){const D=await y.text();throw console.error("[LocationContext] Error response:",D),new Error("Failed to check rain status")}const w=await y.json();console.log("[LocationContext] Feed response:",w);const $=!w.message;console.log("[LocationContext] Rain detected:",$,"Message:",w.message,"Count:",w.count,"Droplets:",w.droplets.length),d($),f(w.count||0),p(null)}catch(g){const y=g instanceof Error?g.message:"Failed to check rain status";console.error("[LocationContext] Error checking rain status:",g),p(y)}},b={latitude:o,longitude:r,isRaining:x,rainAreaSize:j,isLoading:u,error:S,refreshRainStatus:async()=>{await h()},setManualLocation:(g,y)=>{console.warn("Manual location override is only available in development mode")}};return e.jsx(T.Provider,{value:b,children:t})}function k(){const t=s.useContext(T);if(t===void 0)throw new Error("useLocation must be used within a LocationProvider");return t}const U="/api",C=500;function Y({onDropletCreated:t}){const[a,l]=s.useState(""),[o,c]=s.useState(!1),[r,n]=s.useState(null),{token:x}=L(),{latitude:d,longitude:j}=k(),f=a.length,u=f===0||f>C||o,m=async S=>{if(S.preventDefault(),!d||!j){n("Location not available");return}if(!u){c(!0),n(null);try{const p=await fetch(`${U}/droplets`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${x}`},body:JSON.stringify({droplet:{content:a,latitude:d,longitude:j}})});if(!p.ok){const h=await p.json();throw new Error(h.error||"Failed to post droplet")}const N=await p.json();t(N.droplet),l(""),n(null)}catch(p){const N=p instanceof Error?p.message:"Failed to post droplet";n(N)}finally{c(!1)}}};return e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6",children:e.jsxs("form",{onSubmit:m,children:[e.jsx("textarea",{value:a,onChange:S=>l(S.target.value),placeholder:"What's happening in the rain?",className:"w-full text-gray-900 p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:3,disabled:o}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:`text-sm font-medium ${f>C?"text-red-600":f>C*.9?"text-orange-600":"text-gray-500"}`,children:[f," / ",C]})}),e.jsx("button",{type:"submit",disabled:u,className:`px-6 py-2 rounded-full font-medium transition-colors ${u?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-blue-500 text-white hover:bg-blue-600"}`,children:o?"Posting...":"Post"})]}),r&&e.jsx("div",{className:"mt-3 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-800",children:r})})]})})}function G(t){const a=new Date(t),o=new Date().getTime()-a.getTime(),c=Math.floor(o/1e3),r=Math.floor(c/60),n=Math.floor(r/60),x=Math.floor(n/24);return c<60?"just now":r<60?`${r} minute${r!==1?"s":""} ago`:n<24?`${n} hour${n!==1?"s":""} ago`:x<7?`${x} day${x!==1?"s":""} ago`:a.toLocaleDateString()}function V({droplet:t}){return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow",children:[e.jsx("div",{className:"flex items-start justify-between mb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-semibold",children:t.user.email.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.user.email}),e.jsx("p",{className:"text-sm text-gray-500",children:G(t.inserted_at)})]})]})}),e.jsx("p",{className:"text-gray-800 whitespace-pre-wrap break-words",children:t.content}),e.jsxs("div",{className:"mt-3 flex items-center gap-2 text-xs text-gray-400",children:[e.jsx("span",{children:"ðŸ“"}),e.jsxs("span",{children:[t.latitude.toFixed(2),", ",t.longitude.toFixed(2)]})]})]})}function W({dropletCount:t}){return e.jsxs("div",{className:"bg-blue-100 text-blue-800 px-4 py-2 rounded-full inline-flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"ðŸŒ§ï¸"}),e.jsxs("span",{className:"font-medium",children:[t," droplet",t!==1?"s":""," in your rain area"]})]})}const X="/api",Q=3e4;function Z(){const[t,a]=s.useState([]),[l,o]=s.useState(!0),[c,r]=s.useState(null),{token:n}=L(),{latitude:x,longitude:d}=k();s.useEffect(()=>{x&&d&&n&&j()},[x,d,n]),s.useEffect(()=>{if(!x||!d||!n)return;const u=setInterval(()=>{j()},Q);return()=>clearInterval(u)},[x,d,n]);const j=async()=>{if(!(!x||!d||!n))try{const u=await fetch(`${X}/droplets/feed?latitude=${x}&longitude=${d}`,{headers:{Authorization:`Bearer ${n}`}});if(!u.ok)throw new Error("Failed to load feed");const m=await u.json();a(m.droplets),r(null)}catch(u){const m=u instanceof Error?u.message:"Failed to load feed";r(m)}finally{o(!1)}},f=u=>{a(m=>[u,...m])};return l?e.jsx("div",{className:"min-h-full bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"text-4xl animate-pulse",children:"ðŸŒ§ï¸"}),e.jsx("p",{className:"text-gray-600",children:"Loading feed..."})]})}):e.jsx("div",{className:"min-h-full bg-gray-50",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ðŸŒ§ï¸ Raining"}),e.jsx(W,{dropletCount:t.length})]}),e.jsx(Y,{onDropletCreated:f}),c&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-800",children:c})}),e.jsx("div",{className:"space-y-4",children:t.length===0?e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center",children:[e.jsx("div",{className:"text-4xl mb-4",children:"ðŸ’§"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No droplets yet"}),e.jsx("p",{className:"text-gray-600",children:"Be the first to post in your rain area!"})]}):t.map(u=>e.jsx(V,{droplet:u},u.id))})]})})}function ee(){return e.jsx("div",{className:"min-h-full flex items-center justify-center bg-gradient-to-br from-blue-50 to-gray-100",children:e.jsxs("div",{className:"text-center space-y-6 px-4 py-12",children:[e.jsx("h1",{className:"text-6xl font-bold text-gray-800",children:"You have better things to do!"}),e.jsx("p",{className:"text-2xl text-gray-600",children:"Come back when it's raining"}),e.jsx("div",{className:"text-6xl mt-8",children:"â˜€ï¸"})]})})}function te({children:t}){const{isAuthenticated:a,isLoading:l}=L(),{isRaining:o,isLoading:c,error:r}=k();return l||c?e.jsx("div",{className:"min-h-full flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"text-4xl animate-pulse",children:"ðŸŒ§ï¸"}),e.jsx("p",{className:"text-gray-600",children:"Loading..."})]})}):a?r?e.jsx("div",{className:"min-h-full flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center space-y-4 px-4",children:[e.jsx("div",{className:"text-4xl",children:"âš ï¸"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Location Error"}),e.jsx("p",{className:"text-gray-600",children:r}),e.jsx("p",{className:"text-sm text-gray-500",children:"Please enable location permissions and refresh the page"})]})}):o?e.jsx(e.Fragment,{children:t}):e.jsx(ee,{}):e.jsx(O,{to:"/login",replace:!0})}const se=()=>{const{user:t,isAuthenticated:a,logout:l}=L(),o=async()=>{await l()};return e.jsxs("nav",{className:"bg-white shadow-sm px-6 py-4 flex justify-between items-center",children:[e.jsxs(I,{to:"/",className:"flex items-center gap-2 text-xl font-bold text-gray-900 hover:text-blue-600 transition-colors",children:[e.jsx("span",{children:"ðŸŒ§ï¸"}),e.jsx("span",{children:"Raining"})]}),e.jsx("div",{className:"flex gap-4 items-center",children:a?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-600",children:t?.email}),e.jsx("button",{onClick:o,className:"px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors",children:"Logout"})]}):e.jsx(I,{to:"/login",className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors",children:"Login"})})]})};function ne(){const{latitude:t,longitude:a,setManualLocation:l}=k(),[o,c]=s.useState(!1),[r,n]=s.useState(t?.toString()??""),[x,d]=s.useState(a?.toString()??""),[j,f]=s.useState(!1);return s.useEffect(()=>{t!==null&&r===""&&n(t.toString()),a!==null&&x===""&&d(a.toString())},[t,a]),null}const ae=()=>e.jsx(z,{children:e.jsx(K,{children:e.jsxs("div",{className:"h-screen w-screen flex flex-col",children:[e.jsx(se,{}),e.jsx("div",{className:"flex-1",children:e.jsxs(_,{children:[e.jsx(R,{path:"/login",element:e.jsx(H,{})}),e.jsx(R,{path:"/",element:e.jsx(te,{children:e.jsx(Z,{})})})]})}),e.jsx(ne,{})]})})}),oe=B(function(){return e.jsx(ae,{})});export{oe as default};
