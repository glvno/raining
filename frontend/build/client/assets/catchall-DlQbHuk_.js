import{a as n,q as e,v as M,x as O,y as I,z as _,A as R,w as B}from"./chunk-JMJ3UQ3L-DyXDjqW6.js";const E="raining_auth_token",A="/api",F=n.createContext(void 0);function z({children:t}){const[r,l]=n.useState(null),[o,c]=n.useState(null),[a,s]=n.useState(!0),[x,d]=n.useState(null),v=!!r&&!!o;n.useEffect(()=>{const h=localStorage.getItem(E);h?(l(h),f(h)):s(!1)},[]);const f=async h=>{const j=h||r;if(!j){s(!1);return}try{const i=await fetch(`${A}/me`,{headers:{Authorization:`Bearer ${j}`}});if(i.ok){const b=await i.json();c(b),l(j),localStorage.setItem(E,j)}else l(null),c(null),localStorage.removeItem(E)}catch{d("Failed to verify authentication"),l(null),c(null),localStorage.removeItem(E)}finally{s(!1)}},N={token:r,user:o,isAuthenticated:v,isLoading:a,error:x,login:async(h,j)=>{s(!0),d(null);try{const i=await fetch(`${A}/users/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:h,password:j})});if(!i.ok){const g=await i.json();throw new Error(g.error||"Login failed")}const b=await i.json();l(b.token),c(b.user),localStorage.setItem(E,b.token)}catch(i){const b=i instanceof Error?i.message:"Login failed";throw d(b),i}finally{s(!1)}},register:async(h,j)=>{s(!0),d(null);try{const i=await fetch(`${A}/users/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user:{email:h,password:j}})});if(!i.ok){const g=await i.json();throw new Error(g.error||"Registration failed")}const b=await i.json();l(b.token),c(b.user),localStorage.setItem(E,b.token)}catch(i){const b=i instanceof Error?i.message:"Registration failed";throw d(b),i}finally{s(!1)}},logout:async()=>{s(!0);try{r&&await fetch(`${A}/users/logout`,{method:"DELETE",headers:{Authorization:`Bearer ${r}`}})}catch(h){console.error("Logout API call failed:",h)}finally{l(null),c(null),localStorage.removeItem(E),s(!1)}},checkAuth:()=>f(),clearError:()=>d(null)};return e.jsx(F.Provider,{value:N,children:t})}function L(){const t=n.useContext(F);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t}const H=()=>{const t=M(),{login:r,register:l,error:o,clearError:c,isAuthenticated:a}=L(),[s,x]=n.useState("login"),[d,v]=n.useState(""),[f,u]=n.useState(""),[m,S]=n.useState(!1),[p,N]=n.useState(null);n.useEffect(()=>{a&&t("/",{replace:!0})},[a,t]);const h=async i=>{i.preventDefault(),S(!0),N(null),c();try{s==="login"?await r(d,f):await l(d,f)}catch{}finally{S(!1)}},j=i=>{x(i),N(null),c()};return e.jsx("div",{className:"min-h-full bg-gradient-to-br from-blue-50 to-gray-100 flex items-center justify-center px-4 py-12",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-8 w-full max-w-md",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold text-gray-900 mb-2",children:"ðŸŒ§ï¸ Raining"}),e.jsx("p",{className:"text-gray-600",children:s==="login"?"Welcome back!":"Create your account"})]}),e.jsxs("div",{className:"flex gap-2 mb-6",children:[e.jsx("button",{type:"button",onClick:()=>j("login"),className:`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${s==="login"?"bg-blue-500 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"Login"}),e.jsx("button",{type:"button",onClick:()=>j("register"),className:`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${s==="register"?"bg-blue-500 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"Register"})]}),e.jsxs("form",{onSubmit:h,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{id:"email",type:"email",value:d,onChange:i=>v(i.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"you@example.com",disabled:m})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),e.jsx("input",{id:"password",type:"password",value:f,onChange:i=>u(i.target.value),required:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",disabled:m})]}),e.jsx("button",{type:"submit",disabled:m,className:`w-full py-3 rounded-lg font-medium transition-colors ${m?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-blue-500 text-white hover:bg-blue-600"}`,children:m?"Please wait...":s==="login"?"Login":"Create Account"})]}),p&&e.jsx("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-green-800",children:p})}),o&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-800",children:o})})]})})},P="raining_location",J="/api",q=3e4,T=n.createContext(void 0);function K({children:t}){const{token:r,isAuthenticated:l}=L(),[o,c]=n.useState(null),[a,s]=n.useState(null),[x,d]=n.useState(!1),[v,f]=n.useState(0),[u,m]=n.useState(!0),[S,p]=n.useState(null);n.useEffect(()=>{const g=localStorage.getItem(P);if(g)try{const{lat:y,lng:w}=JSON.parse(g);c(y),s(w)}catch(y){console.error("Failed to parse cached location:",y)}},[]),n.useEffect(()=>{!o||!a?N():m(!1)},[]),n.useEffect(()=>{o&&a&&l&&r&&h()},[o,a,l,r]),n.useEffect(()=>{if(!o||!a||!l||!r)return;const g=setInterval(()=>{h()},q);return()=>clearInterval(g)},[o,a,l,r]);const N=()=>{if(m(!0),p(null),!navigator.geolocation){p("Geolocation is not supported by your browser"),m(!1);return}navigator.geolocation.getCurrentPosition(g=>{const y=g.coords.latitude,w=g.coords.longitude;c(y),s(w),localStorage.setItem(P,JSON.stringify({lat:y,lng:w})),m(!1)},g=>{p(`Unable to get location: ${g.message}`),m(!1)},{enableHighAccuracy:!1,timeout:1e4,maximumAge:3e5})},h=async()=>{if(!(!o||!a||!r))try{const g=`${J}/droplets/feed?latitude=${o}&longitude=${a}`;console.log("[LocationContext] Checking rain status at:",{latitude:o,longitude:a,url:g});const y=await fetch(g,{headers:{Authorization:`Bearer ${r}`}});if(console.log("[LocationContext] Response status:",y.status),!y.ok){const D=await y.text();throw console.error("[LocationContext] Error response:",D),new Error("Failed to check rain status")}const w=await y.json();console.log("[LocationContext] Feed response:",w);const $=!w.message;console.log("[LocationContext] Rain detected:",$,"Message:",w.message,"Count:",w.count,"Droplets:",w.droplets.length),d($),f(w.count||0),p(null)}catch(g){const y=g instanceof Error?g.message:"Failed to check rain status";console.error("[LocationContext] Error checking rain status:",g),p(y)}},b={latitude:o,longitude:a,isRaining:x,rainAreaSize:v,isLoading:u,error:S,refreshRainStatus:async()=>{await h()},setManualLocation:(g,y)=>{console.warn("Manual location override is only available in development mode")}};return e.jsx(T.Provider,{value:b,children:t})}function k(){const t=n.useContext(T);if(t===void 0)throw new Error("useLocation must be used within a LocationProvider");return t}const U="/api",C=500;function Y({onDropletCreated:t}){const[r,l]=n.useState(""),[o,c]=n.useState(!1),[a,s]=n.useState(null),{token:x}=L(),{latitude:d,longitude:v}=k(),f=r.length,u=f===0||f>C||o,m=async S=>{if(S.preventDefault(),!d||!v){s("Location not available");return}if(!u){c(!0),s(null);try{const p=await fetch(`${U}/droplets`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${x}`},body:JSON.stringify({droplet:{content:r,latitude:d,longitude:v}})});if(!p.ok){const h=await p.json();throw new Error(h.error||"Failed to post droplet")}const N=await p.json();t(N.droplet),l(""),s(null)}catch(p){const N=p instanceof Error?p.message:"Failed to post droplet";s(N)}finally{c(!1)}}};return e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6",children:e.jsxs("form",{onSubmit:m,children:[e.jsx("textarea",{value:r,onChange:S=>l(S.target.value),placeholder:"What's happening in the rain?",className:"w-full text-gray-900 p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:3,disabled:o}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:`text-sm font-medium ${f>C?"text-red-600":f>C*.9?"text-orange-600":"text-gray-500"}`,children:[f," / ",C]})}),e.jsx("button",{type:"submit",disabled:u,className:`px-6 py-2 rounded-full font-medium transition-colors ${u?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-blue-500 text-white hover:bg-blue-600"}`,children:o?"Posting...":"Post"})]}),a&&e.jsx("div",{className:"mt-3 p-3 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-800",children:a})})]})})}function G(t){const r=new Date(t),o=new Date().getTime()-r.getTime(),c=Math.floor(o/1e3),a=Math.floor(c/60),s=Math.floor(a/60),x=Math.floor(s/24);return c<60?"just now":a<60?`${a} minute${a!==1?"s":""} ago`:s<24?`${s} hour${s!==1?"s":""} ago`:x<7?`${x} day${x!==1?"s":""} ago`:r.toLocaleDateString()}function V({droplet:t}){return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow",children:[e.jsx("div",{className:"flex items-start justify-between mb-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-semibold",children:t.user.email.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:t.user.email}),e.jsx("p",{className:"text-sm text-gray-500",children:G(t.inserted_at)})]})]})}),e.jsx("p",{className:"text-gray-800 whitespace-pre-wrap break-words",children:t.content}),e.jsxs("div",{className:"mt-3 flex items-center gap-2 text-xs text-gray-400",children:[e.jsx("span",{children:"ðŸ“"}),e.jsxs("span",{children:[t.latitude.toFixed(2),", ",t.longitude.toFixed(2)]})]})]})}function W({dropletCount:t}){return e.jsxs("div",{className:"bg-blue-100 text-blue-800 px-4 py-2 rounded-full inline-flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:"ðŸŒ§ï¸"}),e.jsxs("span",{className:"font-medium",children:[t," droplet",t!==1?"s":""," in your rain area"]})]})}const X="/api",Q=3e4;function Z(){const[t,r]=n.useState([]),[l,o]=n.useState(!0),[c,a]=n.useState(null),{token:s}=L(),{latitude:x,longitude:d}=k();n.useEffect(()=>{x&&d&&s&&v()},[x,d,s]),n.useEffect(()=>{if(!x||!d||!s)return;const u=setInterval(()=>{v()},Q);return()=>clearInterval(u)},[x,d,s]);const v=async()=>{if(!(!x||!d||!s))try{const u=await fetch(`${X}/droplets/feed?latitude=${x}&longitude=${d}`,{headers:{Authorization:`Bearer ${s}`}});if(!u.ok)throw new Error("Failed to load feed");const m=await u.json();r(m.droplets),a(null)}catch(u){const m=u instanceof Error?u.message:"Failed to load feed";a(m)}finally{o(!1)}},f=u=>{r(m=>[u,...m])};return l?e.jsx("div",{className:"min-h-full bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"text-4xl animate-pulse",children:"ðŸŒ§ï¸"}),e.jsx("p",{className:"text-gray-600",children:"Loading feed..."})]})}):e.jsx("div",{className:"min-h-full bg-gray-50",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"ðŸŒ§ï¸ Raining"}),e.jsx(W,{dropletCount:t.length})]}),e.jsx(Y,{onDropletCreated:f}),c&&e.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-800",children:c})}),e.jsx("div",{className:"space-y-4",children:t.length===0?e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center",children:[e.jsx("div",{className:"text-4xl mb-4",children:"ðŸ’§"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No droplets yet"}),e.jsx("p",{className:"text-gray-600",children:"Be the first to post in your rain area!"})]}):t.map(u=>e.jsx(V,{droplet:u},u.id))})]})})}function ee(){return e.jsx("div",{className:"min-h-full flex items-center justify-center bg-gradient-to-br from-blue-50 to-gray-100",children:e.jsxs("div",{className:"text-center space-y-6 px-4 py-12",children:[e.jsx("h1",{className:"text-6xl font-bold text-gray-800",children:"You have better things to do!"}),e.jsx("p",{className:"text-2xl text-gray-600",children:"Come back when it's raining"}),e.jsx("div",{className:"text-6xl mt-8",children:"â˜€ï¸"})]})})}function te({children:t}){const{isAuthenticated:r,isLoading:l}=L(),{isRaining:o,isLoading:c,error:a}=k();return l||c?e.jsx("div",{className:"min-h-full flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"text-4xl animate-pulse",children:"ðŸŒ§ï¸"}),e.jsx("p",{className:"text-gray-600",children:"Loading..."})]})}):r?a?e.jsx("div",{className:"min-h-full flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center space-y-4 px-4",children:[e.jsx("div",{className:"text-4xl",children:"âš ï¸"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"Location Error"}),e.jsx("p",{className:"text-gray-600",children:a}),e.jsx("p",{className:"text-sm text-gray-500",children:"Please enable location permissions and refresh the page"})]})}):o?e.jsx(e.Fragment,{children:t}):e.jsx(ee,{}):e.jsx(O,{to:"/login",replace:!0})}const se=()=>{const{user:t,isAuthenticated:r,logout:l}=L(),o=async()=>{await l()};return e.jsxs("nav",{className:"bg-white shadow-sm px-6 py-4 flex justify-between items-center",children:[e.jsxs(I,{to:"/",className:"flex items-center gap-2 text-xl font-bold text-gray-900 hover:text-blue-600 transition-colors",children:[e.jsx("span",{children:"ðŸŒ§ï¸"}),e.jsx("span",{children:"Raining"})]}),e.jsx("div",{className:"flex gap-4 items-center",children:r?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-600",children:t?.email}),e.jsx("button",{onClick:o,className:"px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors",children:"Logout"})]}):e.jsx(I,{to:"/login",className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors",children:"Login"})})]})};function ne(){const{latitude:t,longitude:r,setManualLocation:l}=k(),[o,c]=n.useState(!1),[a,s]=n.useState(t?.toString()??""),[x,d]=n.useState(r?.toString()??"");return n.useEffect(()=>{t!==null&&a===""&&s(t.toString()),r!==null&&x===""&&d(r.toString())},[t,r]),null}const re=()=>e.jsx(z,{children:e.jsx(K,{children:e.jsxs("div",{className:"h-screen w-screen flex flex-col",children:[e.jsx(se,{}),e.jsx("div",{className:"flex-1",children:e.jsxs(_,{children:[e.jsx(R,{path:"/login",element:e.jsx(H,{})}),e.jsx(R,{path:"/",element:e.jsx(te,{children:e.jsx(Z,{})})})]})}),e.jsx(ne,{})]})})}),oe=B(function(){return e.jsx(re,{})});export{oe as default};
